@using LogiHub.Services.Shared
@using LogiHub.Web.Features.SearchCard
@model LogiHub.Web.Features.SearchCard.SearchCardViewModel

<div class="d-flex justify-content-between align-items-center p-3">
    @* GRUPPO TITOLO + INDIETRO *@
    <div class="d-flex align-items-center">
        @* Titolo *@
        @if (!string.IsNullOrEmpty(Model.Title))
        {
            <h1 class="h3 mb-0 text-gray-800">@Model.Title</h1>
        }
    </div>

    @* BOTTONI AZIONE (Destra) *@
    @if (Model.HeaderButtons != null && Model.HeaderButtons.Any())
    {
        <div class="d-flex gap-2">
            @foreach (var btn in Model.HeaderButtons)
            {
                string postUrl = null;

                // Logica per gestire i bottoni POST vs GET/JS
                var isPost = btn.HtmlAttributes != null
                             && btn.HtmlAttributes.TryGetValue("data-post-action", out var postVal)
                             && postVal == "true" // Verifica se è un'azione POST simulata
                             && btn.HtmlAttributes.TryGetValue("data-url", out postUrl) // Estrae l'URL
                             && !string.IsNullOrWhiteSpace(postUrl);

                if (isPost)
                {
                    <form method="post" action="@postUrl" class="d-inline">
                        @Html.AntiForgeryToken()

                        <button type="submit"
                                class="btn @btn.CssClass"
                                data-confirm-modal-trigger="true"
                                @if (btn.HtmlAttributes != null)
                                {
                                    foreach (var attr in btn.HtmlAttributes)
                                    {
                                        // Evitiamo di ristampare gli attributi interni usati per la logica
                                        if (attr.Key != "data-post-action" && attr.Key != "data-url")
                                        {
                                            @Html.Raw($"{attr.Key}=\"{attr.Value}\" ")
                                        }
                                    }
                                }>
                            @if (!string.IsNullOrEmpty(btn.IconClass))
                            {
                                <i class="@btn.IconClass me-2"></i>
                            }
                            @btn.Text
                        </button>
                    </form>
                }
                else
                {
                    <button type="@btn.Type"
                            class="btn @btn.CssClass"
                            @if (btn.HtmlAttributes != null)
                            {
                                foreach (var attr in btn.HtmlAttributes)
                                {
                                    @Html.Raw($"{attr.Key}=\"{attr.Value}\" ")
                                }
                            }>
                        @if (!string.IsNullOrEmpty(btn.IconClass))
                        {
                            <i class="@btn.IconClass me-2"></i>
                        }
                        @btn.Text
                    </button>
                }
            }
        </div>
    }
</div>


<div class="card shadow-sm mb-3 border-0">
    <div class="card-body p-2 p-md-3">
        <form method="get">
            @{
                var anyRightFilter = Model.ShowUscitoFilter;
                var addBottomSpacing = anyRightFilter || Model.ShowSearchInColumns;
            }

            <div class="row g-2 @(addBottomSpacing ? "mb-3" : "")">
                <div class="@(anyRightFilter ? "col-8 col-md-8" : "col-12 col-md-10")">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-end-0 text-muted">
                            <i class="fas fa-search"></i>
                        </span>
                        <div class="form-floating">
                            <input name="Query"
                                   id="searchQuery"
                                   type="text"
                                   value="@Model.Query"
                                   class="form-control border-start-0"
                                   placeholder="@(string.IsNullOrEmpty(Model.Placeholder) ? "Cerca..." : Model.Placeholder)"/>
                            <label for="searchQuery">Ricerca</label>
                        </div>
                    </div>
                </div>

                @if (Model.ShowUscitoFilter)
                {
                    <div class="col-4 col-md-2">
                        <div class="form-floating">
                            <select class="form-select" id="filterUscito" name="Filters.Uscito"
                                    onchange="this.form.submit()">
                                <option value="0" selected="@(Model.Filters.Uscito == TriState.All)">Tutti</option>
                                <option value="1" selected="@(Model.Filters.Uscito == TriState.True)">Sì</option>
                                <option value="2" selected="@(Model.Filters.Uscito == TriState.False)">No</option>
                            </select>
                            <label for="filterUscito">Uscito</label>
                        </div>
                    </div>
                }

                <div class="col-12 col-md-2">
                    <button type="submit"
                            class="btn btn-primary w-100 h-100 d-flex align-items-center justify-content-center">
                        <i class="fas fa-search me-2"></i>Cerca
                    </button>
                </div>
            </div>

            @if (Model.ShowSearchInColumns)
            {
                <div class="d-flex align-items-center flex-wrap gap-2">
                    <span class="small text-uppercase text-muted fw-bold">Cerca in:</span>

                    @{
                        var options = Model.SearchInColumns ?? new List<SearchInColumnOption>();
                        var currentFilters = Model.Filters.SearchInColumns ?? new List<string>();
                    }

                    @foreach (var opt in options)
                    {
                        var isChecked = currentFilters.Contains(opt.Key);
                        var id = $"col_{opt.Key}";

                        <input type="checkbox" class="btn-check" id="@id" name="Filters.SearchInColumns"
                               value="@opt.Key"
                               autocomplete="off" @(isChecked ? "checked" : "")>
                        <label class="btn btn-outline-primary btn-sm rounded-pill" for="@id">@opt.Label</label>
                    }
                </div>
            }
        </form>
    </div>
</div>