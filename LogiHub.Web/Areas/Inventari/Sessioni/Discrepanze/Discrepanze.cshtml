@model LogiHub.Web.Areas.Inventari.Sessioni.Discrepanze.DiscrepanzeViewModel

@{
    ViewData["Title"] = "Analisi Discrepanze";

    // Conteggio solo delle pratiche ancora da gestire
    var countSpostati = Model.DaSpostare?.Count(x => x.Stato == StatoDiscrepanza.Aperta) ?? 0;
    var countExtra = Model.DaAggiungere?.Count(x => x.Stato == StatoDiscrepanza.Aperta) ?? 0;
    var countMancanti = Model.DaRimuovere?.Count(x => x.Stato == StatoDiscrepanza.Aperta) ?? 0;
    bool tuttoRisolto = !Model.IsSolaLettura &&
                        countSpostati == 0 && countExtra == 0 && countMancanti == 0;
}


@if (Model.IsSolaLettura)
{
    <div class="alert alert-warning border-0 shadow-sm mb-3 d-flex align-items-center">
        <i class="fa-solid fa-lock me-3 fa-lg"></i>
        <div>
            <strong>Risoluzione Bloccata:</strong> Ci sono ancora ubicazioni aperte.
            Devi terminare il conteggio fisico prima di allineare il magazzino.
        </div>
    </div>
}

@* --- 2. LOGICA TABELLA SEMPLIFICATA --- *@

@functions {

    string GetStatoBadge(StatoDiscrepanza stato) => stato switch
    {
        StatoDiscrepanza.Risolta => "bg-success",
        StatoDiscrepanza.Annullata => "bg-secondary",
        _ => "bg-warning text-dark"
    };

    async Task RenderTabella(IEnumerable<DiscrepanzaDTO> items, string colorClass, TipoRisoluzione tipoDefault, string tabId)
    {
        @* --- VERSIONE DESKTOP (TABELLA) --- *@
        <div class="card shadow-sm border-0 border-start border-4 border-@colorClass d-none d-md-block">
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                    <tr>
                        <th>Pezzo</th>
                        <th>Info</th>
                        <th>Stato</th>
                        <th class="text-end pe-3">Azioni</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var item in items)
                    {
                        <tr class="@(item.Stato != StatoDiscrepanza.Aperta ? "opacity-75 bg-light" : "")">
                            <td>
                                <div class="fw-bold">@item.Barcode</div>
                                <div class="small text-muted">@item.Descrizione</div>
                            </td>
                            <td>
                                @if (item.Tipo == TipoDiscrepanzaOperativa.Spostato)
                                {
                                    <small>Da <b>@item.UbicazioneSnapshot</b> Trovato in <b>@item.UbicazioneRilevata</b></small>
                                }
                                else if (item.Tipo == TipoDiscrepanzaOperativa.Extra)
                                {
                                    <small>Trovato in <b>@item.UbicazioneRilevata</b></small>
                                }
                                else
                                {
                                    <small>Mancante da <b>@item.UbicazioneSnapshot</b></small>
                                }
                            </td>
                            <td>
                                <span class="badge @GetStatoBadge(item.Stato)">@item.Stato</span>
                                @if (item.Stato != StatoDiscrepanza.Aperta)
                                {
                                    <div class="x-small text-muted mt-1" style="font-size: 0.7rem;">
                                        @item.GestitaDa il @item.DataGestione?.ToString("dd/MM HH:mm")
                                    </div>
                                }
                            </td>

                            <td class="text-end pe-3">
                                @if (item.Stato != StatoDiscrepanza.Aperta)
                                {
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-secondary disabled">
                                            <i class="fa-solid fa-lock me-2"></i>Risolvi
                                        </button>
                                        <button class="btn btn-sm btn-secondary disabled">
                                            <i class="fa-solid fa-lock me-2"></i>Annulla
                                        </button>
                                    </div>
                                }
                                else if (Model.IsSolaLettura)
                                {
                                    // 2. SE È APERTA MA INVENTARIO BLOCCATO -> Mostra lucchetto
                                    <button class="btn btn-secondary disabled">
                                    <i class="fa-solid fa-lock" title="Completa prima l'inventario"></i>
                                    </button>
                                }
                                else
                                {
                                    // 3. SE È APERTA E INVENTARIO FINITO -> Mostra pulsanti
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-success"
                                                type="button"
                                                onclick="avviaRisoluzione(this, '@Url.Action("Risolvi", "Discrepanze", new { area = "Inventari", id = Model.SessioneId, barcode = item.Barcode, tipo = tipoDefault })', 'Confermi la risoluzione (aggiornamento magazzino)?')">
                                            <i class="fa-solid fa-check me-2"></i>Risolvi
                                        </button>

                                        <button class="btn btn-sm btn-outline-danger"
                                                type="button"
                                                onclick="avviaRisoluzione(this, '@Url.Action("AnnullaDiscrepanza", "Discrepanze", new { area = "Inventari", id = Model.SessioneId, barcode = item.Barcode })', 'Vuoi annullare la segnalazione? Non verrà fatta alcuna modifica fisica.')">
                                            <i class="fa-solid fa-ban me-2"></i>Annulla
                                        </button>
                                    </div>
                                }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>

        @* --- VERSIONE MOBILE (CARDS) --- *@
        <div class="d-md-none">
            @foreach (var item in items)
            {
                <div class="card shadow-sm border-0 border-start border-4 @(item.Stato == StatoDiscrepanza.Risolta ? "border-success" : item.Stato == StatoDiscrepanza.Annullata ? "border-danger" : "border-" + colorClass) mb-3 mobile-item-card @(item.Stato != StatoDiscrepanza.Aperta ? "opacity-75 bg-light" : "")">
                    <div class="card-body p-3">
                        @* Header: Barcode e Stato *@
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="fw-bold fs-5">@item.Barcode</div>
                                <div class="small text-muted">@item.Descrizione</div>
                            </div>
                            <div class="status-cell text-end">
                                <span class="badge @GetStatoBadge(item.Stato)">@item.Stato</span>
                                @if (item.Stato != StatoDiscrepanza.Aperta)
                                {
                                    <div class="x-small text-muted mt-1" style="font-size: 0.7rem;">
                                        @item.GestitaDa <br/> il @item.DataGestione?.ToString("dd/MM HH:mm")
                                    </div>
                                }
                            </div>
                        </div>

                        @* Info Discrepanza *@
                        <div class="mb-3 small bg-light p-2 rounded text-muted">
                            @if (item.Tipo == TipoDiscrepanzaOperativa.Spostato)
                            {
                                <span><i class="fa-solid fa-arrow-right-arrow-left me-1"></i> Da <b>@item.UbicazioneSnapshot</b> &rarr; <b>@item.UbicazioneRilevata</b></span>
                            }
                            else if (item.Tipo == TipoDiscrepanzaOperativa.Extra)
                            {
                                <span><i class="fa-solid fa-plus me-1"></i> Trovato in <b>@item.UbicazioneRilevata</b></span>
                            }
                            else
                            {
                                <span><i class="fa-solid fa-minus me-1"></i> Mancante da <b>@item.UbicazioneSnapshot</b></span>
                            }
                        </div>

                        @* Azioni *@
                        <div class="action-cell">
                            @if (item.Stato != StatoDiscrepanza.Aperta)
                            {
                                <div class="d-flex gap-2">
                                    <button class="btn btn-secondary flex-grow-1 fw-bold py-2 disabled">
                                        <i class="fa-solid fa-lock me-2"></i>Risolvi
                                    </button>
                                    <button class="btn btn-secondary py-2 px-3 disabled">
                                        <i class="fa-solid fa-lock"></i>
                                    </button>
                                </div>
                            }
                            else if (Model.IsSolaLettura)
                            {
                                <div class="d-grid">
                                    <button class="btn btn-secondary disabled">
                                        <i class="fa-solid fa-lock me-2"></i>Risoluzione Bloccata
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-success flex-grow-1 fw-bold py-2"
                                            type="button"
                                            onclick="avviaRisoluzione(this, '@Url.Action("Risolvi", "Discrepanze", new { area = "Inventari", id = Model.SessioneId, barcode = item.Barcode, tipo = tipoDefault })', 'Confermi la risoluzione (aggiornamento magazzino)?')">
                                        <i class="fa-solid fa-check me-2"></i>Risolvi
                                    </button>

                                    <button class="btn btn-outline-danger py-2 px-3"
                                            type="button"
                                            title="Annulla"
                                            onclick="avviaRisoluzione(this, '@Url.Action("AnnullaDiscrepanza", "Discrepanze", new { area = "Inventari", id = Model.SessioneId, barcode = item.Barcode })', 'Vuoi annullare la segnalazione? Non verrà fatta alcuna modifica fisica.')">
                                        <i class="fa-solid fa-ban"></i>
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }

}

<div>
    @await Html.PartialAsync("~/Features/SearchCard/_SearchCard.cshtml", Model.SearchCard)
</div>

<div class="container-fluid mt-3">
    @* --- TABS --- *@
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="tab-spostati" data-bs-toggle="pill" data-bs-target="#content-spostati"
                    type="button" role="tab">
                <i class="fa-solid fa-right-left me-2"></i>Spostamenti 
                @if (countSpostati > 0)
                {
                    <span class="badge bg-white text-primary ms-1">@countSpostati</span>
                }
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-extra" data-bs-toggle="pill" data-bs-target="#content-extra" type="button"
                    role="tab">
                <i class="fa-solid fa-plus me-2"></i>Extra 
                @if (countExtra > 0)
                {
                    <span class="badge bg-white text-primary ms-1">@countExtra</span>
                }
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-mancanti" data-bs-toggle="pill" data-bs-target="#content-mancanti"
                    type="button" role="tab">
                <i class="fa-solid fa-minus me-2"></i>Mancanti 
                @if (countMancanti > 0)
                {
                    <span class="badge bg-white text-primary ms-1">@countMancanti</span>
                }
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="content-spostati" role="tabpanel">
            @{ await RenderTabella(Model.DaSpostare, "primary", TipoRisoluzione.Sposta, "content-spostati"); }
        </div>
        <div class="tab-pane fade" id="content-extra" role="tabpanel">
            @{ await RenderTabella(Model.DaAggiungere, "primary", TipoRisoluzione.Aggiungi, "content-extra"); }
        </div>
        <div class="tab-pane fade" id="content-mancanti" role="tabpanel">
            @{ await RenderTabella(Model.DaRimuovere, "primary", TipoRisoluzione.Rimuovi, "content-mancanti"); }
        </div>
    </div>
</div>

@Html.AntiForgeryToken()

@await Html.PartialAsync(
    "~/Features/Modals/_ConfirmModal.cshtml",
    new LogiHub.Web.Features.Modals.ConfirmModalViewModel
    {
        ModalId = "actionConfirmModal",
        Title = "Conferma operazione",
        Message = "",
        ConfirmButtonText = "Conferma",
        ConfirmButtonClass = "btn-primary",
        IconClass = "fa-solid fa-solid fa-wand-magic-sparkles text-primary"
    })
    
@* --- MODALE DEDICATO PER AJAX (Separato da quello generico per evitare conflitti) --- *@
@await Html.PartialAsync(
    "~/Features/Modals/_ConfirmModal.cshtml",
    new LogiHub.Web.Features.Modals.ConfirmModalViewModel
    {
        ModalId = "ajaxConfirmModal",
        Title = "Conferma",
        Message = "",
        ConfirmButtonText = "Conferma",
        ConfirmButtonClass = "btn-primary",
        IconClass = "fa-solid fa-check-circle text-primary"
    })

@section Scripts {
    <script src="~/js/Features/Modals/ConfirmModal.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 1. All'avvio, se c'è un hash nell'URL, attiva il tab corrispondente
            const hash = window.location.hash;
            if (hash) {
                const tabTriggerEl = document.querySelector(`button[data-bs-target="${hash}"]`);
                if (tabTriggerEl) {
                    new bootstrap.Tab(tabTriggerEl).show();
                }
            }

            // 2. Ogni volta che si cambia tab, aggiorna l'hash nell'URL
            const tabs = document.querySelectorAll('button[data-bs-toggle="pill"]');
            tabs.forEach(tab => {
                tab.addEventListener('shown.bs.tab', (e) => {
                    const target = e.target.getAttribute('data-bs-target');
                    history.replaceState(null, null, target); // Aggiorna URL senza ricaricare
                });
            });
        });

        function avviaRisoluzione(btn, url, msg) {
            const modalEl = document.getElementById('ajaxConfirmModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            
            const msgEl = modalEl.querySelector('[data-confirm-message]');
            if(msgEl) msgEl.innerText = msg;
            
            const confirmBtn = modalEl.querySelector('[data-confirm-btn]');
            
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            
            newBtn.onclick = async () => {
                newBtn.disabled = true;
                newBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                
                try {
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                    const formData = new FormData();
                    formData.append('__RequestVerificationToken', token);
                    
                    const res = await fetch(url, { method: 'POST', body: formData });
                    if(res.ok) {
                        const data = await res.json();
                        if(data.success) {
                            modal.hide();
                            aggiornaRigaUI(btn, data);
                        } else {
                            alert("Errore: " + (data.message || "Operazione fallita"));
                        }
                    } else {
                        alert("Errore server: " + res.statusText);
                    }
                } catch(err) {
                    console.error(err);
                    alert("Errore di connessione");
                } finally {
                    newBtn.disabled = false;
                    newBtn.innerText = "Conferma";
                }
            };
            
            modal.show();
        }

        function aggiornaRigaUI(btn, data) {
            const tr = btn.closest('tr');
            const card = btn.closest('.mobile-item-card');
            const container = tr || card;
            
            if(!container) return;
            
            const tabPane = container.closest('.tab-pane');
            
            const badgeClass = data.stato === 'Risolta' ? 'bg-success' : 'bg-secondary';
            const statusHtml = `
                <span class="badge ${badgeClass}">${data.stato}</span>
                <div class="x-small text-muted mt-1" style="font-size: 0.7rem;">
                    ${data.gestitaDa} il ${data.dataGestione}
                </div>
            `;
            
            if (tr) {
                tr.cells[2].innerHTML = statusHtml;
                tr.cells[3].innerHTML = `
                    <div class="btn-group">
                        <button class="btn btn-sm btn-secondary disabled"><i class="fa-solid fa-lock me-2"></i>Risolvi</button>
                        <button class="btn btn-sm btn-secondary disabled"><i class="fa-solid fa-lock me-2"></i>Annulla</button>
                    </div>`;
                tr.classList.add('opacity-75', 'bg-light');
            } else if (card) {
                const statusEl = card.querySelector('.status-cell');
                if(statusEl) statusEl.innerHTML = statusHtml;
                
                const actionEl = card.querySelector('.action-cell');
                if(actionEl) actionEl.innerHTML = `
                    <div class="d-flex gap-2">
                        <button class="btn btn-secondary flex-grow-1 fw-bold py-2 disabled">
                            <i class="fa-solid fa-lock me-2"></i>Risolvi
                        </button>
                        <button class="btn btn-secondary py-2 px-3 disabled">
                            <i class="fa-solid fa-lock"></i>
                        </button>
                    </div>`;
                
                card.classList.remove('border-primary');
                if (data.stato === 'Risolta') card.classList.add('border-success');
                else if (data.stato === 'Annullata') card.classList.add('border-danger');
                
                card.classList.add('opacity-75', 'bg-light');
            }
            
            if(tabPane && tabPane.id) {
                const tabBtnId = tabPane.id.replace('content-', 'tab-');
                const tabBtn = document.getElementById(tabBtnId);
                
                if(tabBtn) {
                    const badge = tabBtn.querySelector('.badge');
                    if(badge) {
                        let count = parseInt(badge.innerText.trim());
                        if(!isNaN(count)) {
                            if(count > 1) badge.innerText = count - 1;
                            else badge.remove();
                        }
                    }
                }
            }
        }
    </script>
}
