@model LogiHub.Web.Areas.Inventari.Sessioni.Discrepanze.DiscrepanzeViewModel

@{
    ViewData["Title"] = "Analisi Discrepanze";

    // Conteggio solo delle pratiche ancora da gestire
    var countSpostati = Model.DaSpostare?.Count(x => x.Stato == StatoDiscrepanza.Aperta) ?? 0;
    var countExtra = Model.DaAggiungere?.Count(x => x.Stato == StatoDiscrepanza.Aperta) ?? 0;
    var countMancanti = Model.DaRimuovere?.Count(x => x.Stato == StatoDiscrepanza.Aperta) ?? 0;
}

@functions {

    string GetStatoBadge(StatoDiscrepanza stato) => stato switch
    {
        StatoDiscrepanza.Risolta => "bg-success",
        StatoDiscrepanza.Annullata => "bg-secondary",
        _ => "bg-warning text-dark"
    };

    // Helper per renderizzare la tabella in modo uniforme
    async Task RenderTabella(IEnumerable<DiscrepanzaDTO> items, string colorClass, TipoRisoluzione tipoDefault, string tabId)
    {
        <div class="card shadow-sm border-0 border-start border-4 border-@colorClass">
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                    <tr>
                        <th>Pezzo</th>
                        <th>Info</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var item in items)
                    {
                        <tr class="@(item.Stato != StatoDiscrepanza.Aperta ? "opacity-75 bg-light" : "")">
                            <td>
                                <div class="fw-bold">@item.Barcode</div>
                                <div class="small text-muted">@item.Descrizione</div>
                            </td>
                            <td>
                                @if (item.Tipo == TipoDiscrepanzaOperativa.Spostato)
                                {
                                    <small>Da <b>@item.UbicazioneSnapshot</b> Trovato in <b>@item.UbicazioneRilevata</b></small>
                                }
                                else if (item.Tipo == TipoDiscrepanzaOperativa.Extra)
                                {
                                    <small>Trovato in <b>@item.UbicazioneRilevata</b></small>
                                }
                                else
                                {
                                    <small>Mancante da <b>@item.UbicazioneSnapshot</b></small>
                                }
                            </td>
                            <td>
                                <span class="badge @GetStatoBadge(item.Stato)">@item.Stato</span>
                                @if (item.Stato != StatoDiscrepanza.Aperta)
                                {
                                    <div class="x-small text-muted mt-1" style="font-size: 0.7rem;">
                                        @item.GestitaDa il @item.DataGestione?.ToString("dd/MM HH:mm")
                                    </div>
                                }
                            </td>
                            <td>
                                @if (item.Stato == StatoDiscrepanza.Aperta)
                                {
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-@colorClass"
                                                data-confirm-trigger="true"
                                                data-url="@Url.Action("Risolvi", "Discrepanze", new { area = "Inventari", id = Model.SessioneId, barcode = item.Barcode, tipo = tipoDefault, activeTab = tabId })"
                                                data-method="POST"
                                                data-type="form"
                                                data-message="Confermi la risoluzione (aggiornamento magazzino)?">
                                            <i class="fa-solid fa-check"></i>
                                        </button>

                                        <button class="btn btn-sm btn-outline-secondary"
                                                data-confirm-trigger="true"
                                                data-url="@Url.Action("AnnullaDiscrepanza", "Discrepanze", new { area = "Inventari", id = Model.SessioneId, barcode = item.Barcode, activeTab = tabId })"
                                                data-method="POST"
                                                data-type="form"
                                                data-message="Vuoi annullare la segnalazione? Non verrà fatta alcuna modifica fisica.">
                                            <i class="fa-solid fa-ban"></i>
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <i class="fa-solid fa-lock text-muted" title="Gestita"></i>
                                }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    }

}

<div>
    @await Html.PartialAsync("~/Features/SearchCard/_SearchCard.cshtml", Model.SearchCard)
</div>

<div class="container-fluid mt-3">
    @* --- TABS --- *@
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="tab-spostati" data-bs-toggle="pill" data-bs-target="#content-spostati"
                    type="button" role="tab">
                <i class="fa-solid fa-right-left me-2"></i>Spostamenti <span
                    class="badge bg-white text-primary ms-1">@countSpostati</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-extra" data-bs-toggle="pill" data-bs-target="#content-extra" type="button"
                    role="tab">
                <i class="fa-solid fa-plus me-2"></i>Extra <span
                    class="badge bg-white text-primary ms-1">@countExtra</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-mancanti" data-bs-toggle="pill" data-bs-target="#content-mancanti"
                    type="button" role="tab">
                <i class="fa-solid fa-minus me-2"></i>Mancanti <span
                    class="badge bg-white text-primary ms-1">@countMancanti</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="content-spostati" role="tabpanel">
            @{ await RenderTabella(Model.DaSpostare, "info", TipoRisoluzione.Sposta, "content-spostati"); }
        </div>
        <div class="tab-pane fade" id="content-extra" role="tabpanel">
            @{ await RenderTabella(Model.DaAggiungere, "primary", TipoRisoluzione.Aggiungi, "content-extra"); }
        </div>
        <div class="tab-pane fade" id="content-mancanti" role="tabpanel">
            @{ await RenderTabella(Model.DaRimuovere, "danger", TipoRisoluzione.Rimuovi, "content-mancanti"); }
        </div>
    </div>
</div>

@Html.AntiForgeryToken()

@await Html.PartialAsync(
    "~/Features/Modals/_ConfirmModal.cshtml",
    new LogiHub.Web.Features.Modals.ConfirmModalViewModel
    {
        ModalId = "actionConfirmModal",
        Title = "Conferma operazione",
        Message = "",
        ConfirmButtonText = "Conferma",
        ConfirmButtonClass = "btn-primary",
        IconClass = "fa-solid fa-solid fa-wand-magic-sparkles text-primary"
    })

@section Scripts {
    <script src="~/js/Features/Modals/ConfirmModal.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 1. All'avvio, se c'è un hash nell'URL, attiva il tab corrispondente
            const hash = window.location.hash;
            if (hash) {
                const tabTriggerEl = document.querySelector(`button[data-bs-target="${hash}"]`);
                if (tabTriggerEl) {
                    new bootstrap.Tab(tabTriggerEl).show();
                }
            }

            // 2. Ogni volta che si cambia tab, aggiorna l'hash nell'URL
            const tabs = document.querySelectorAll('button[data-bs-toggle="pill"]');
            tabs.forEach(tab => {
                tab.addEventListener('shown.bs.tab', (e) => {
                    const target = e.target.getAttribute('data-bs-target');
                    history.replaceState(null, null, target); // Aggiorna URL senza ricaricare
                });
            });
        });
    </script>
}