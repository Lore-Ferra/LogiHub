@model LogiHub.Web.Areas.Inventari.Sessioni.DettaglioSessioneViewModel
@using System.Security.Claims

@{
    ViewData["Title"] = Model.NomeSessione;
}

<!-- Toast Container -->
<div class="toast-container position-fixed end-0 p-3" style="z-index: 1050; top: 70px;">
    @if (TempData["ErrorMessage"] != null)
    {
        <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fa-solid fa-circle-exclamation me-2"></i> @TempData["ErrorMessage"]
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    }
</div>

<div>
    @await Html.PartialAsync("~/Features/SearchCard/_SearchCard.cshtml", Model.SearchCard)
</div>

<div class="card shadow-sm mt-3">
    <div class="card-body p-1">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Ubicazione</th>
                        <th class="text-center text-nowrap">Stato</th>
                        <th class="text-end">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var ubiDaFare = Model.UbicazioniFiltrate.Where(u => !u.Completata && !u.InLavorazione);
                        var ubiInLavorazione = Model.UbicazioniFiltrate.Where(u => u.InLavorazione);
                        var ubiCompletate = Model.UbicazioniFiltrate.Where(u => u.Completata);
                        var currentUserId = Guid.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier));
                    }

                    @if (ubiDaFare.Any())
                    {
                        <tr class="table-secondary">
                            <td colspan="3" class="ps-4 fw-semibold text-muted small uppercase">Da Fare</td>
                        </tr>
                        @foreach (var ubi in ubiDaFare)
                        {
                            <tr>
                                <td class="ps-4">
                                    <a href="@Url.Action("Index", "RilevamentoUbicazione", new { sessioneId = Model.SessioneId, ubicazioneId = ubi.UbicazioneId })" class="text-decoration-none fw-bold">
                                        @ubi.Posizione
                                    </a>
                                </td>
                                <td class="text-center text-nowrap">
                                    <span class="badge rounded-pill bg-light text-dark border">In attesa</span>
                                </td>
                                <td class="text-end text-nowrap">
                                    <a href="@Url.Action("Index", "RilevamentoUbicazione", new { sessioneId = Model.SessioneId, ubicazioneId = ubi.UbicazioneId })" class="btn btn-sm btn-outline-primary">
                                        <span class="d-none d-md-inline">Inizia</span>
                                        <i class="fa-solid fa-play ms-1"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    }

                    @if (ubiInLavorazione.Any())
                    {
                        <tr class="table-secondary">
                            <td colspan="3" class="ps-4 fw-semibold text-muted small uppercase">In Lavorazione</td>
                        </tr>
                        @foreach (var ubi in ubiInLavorazione)
                        {
                            var isMyUbi = ubi.OperatoreCorrenteId == currentUserId;
                            <tr class="table-warning">
                                <td class="ps-4">
                                    <a href="@Url.Action("Index", "RilevamentoUbicazione", new { sessioneId = Model.SessioneId, ubicazioneId = ubi.UbicazioneId })" class="text-decoration-none fw-bold text-dark">
                                        @ubi.Posizione
                                    </a>
                                </td>
                                <td class="text-center text-nowrap">
                                    <span class="badge bg-warning text-dark">Occupato</span>
                                </td>
                                <td class="text-end">
                                    <small class="text-dark d-block d-md-inline mb-1 mb-md-0">
                                        <i class="fa-solid fa-user me-1"></i> @ubi.OperatoreCorrente
                                    </small>
                                    @if (isMyUbi)
                                    {
                                        <a href="@Url.Action("Index", "RilevamentoUbicazione", new { sessioneId = Model.SessioneId, ubicazioneId = ubi.UbicazioneId })" class="btn btn-sm btn-primary ms-2">
                                            <span class="d-none d-md-inline">Riprendi</span>
                                            <i class="fa-solid fa-arrow-right ms-1"></i>
                                        </a>
                                    }
                                </td>
                            </tr>
                        }
                    }

                    @if (ubiCompletate.Any())
                    {
                        <tr class="table-secondary">
                            <td colspan="3" class="ps-4 fw-semibold text-muted small uppercase">Completati</td>
                        </tr>
                        @foreach (var ubi in ubiCompletate)
                        {
                            <tr class="bg-light">
                                <td class="ps-4 text-muted">@ubi.Posizione</td>
                                <td class="text-center text-nowrap">
                                    <span class="badge bg-success">Completato</span>
                                </td>
                                <td class="text-end">
                                    <small class="text-muted">
                                        <span class="d-none d-md-inline">Finito da: </span>
                                        <i class="fa-solid fa-check d-md-none me-1"></i>
                                        @ubi.OperatoreCorrente
                                    </small>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('[data-post-action]');
            if (!btn) return;

            e.preventDefault();

            const url = btn.getAttribute('data-url');
            const confirmMsg = btn.getAttribute('data-confirm');

            if (confirmMsg && !confirm(confirmMsg)) return;

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = url;

            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = '__RequestVerificationToken';
                hiddenInput.value = token.value;
                form.appendChild(hiddenInput);
            }

            document.body.appendChild(form);
            form.submit();
        });

        @if (TempData["ErrorMessage"] != null)
        {
            <text>
            document.addEventListener('DOMContentLoaded', function () {
                var toastEl = document.getElementById('errorToast');
                var toast = new bootstrap.Toast(toastEl, { delay: 5000 });
                toast.show();
            });
            </text>
        }
        
        window.addEventListener('pageshow', function (event) {
            if (event.persisted) {
                window.location.reload();
            }
        });
    </script>
}
@Html.AntiForgeryToken()
