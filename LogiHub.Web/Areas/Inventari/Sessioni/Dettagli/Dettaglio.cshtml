@model LogiHub.Web.Areas.Inventari.Sessioni.DettaglioSessioneViewModel
@using System.Security.Claims

@{
    ViewData["Title"] = Model.NomeSessione;
    var currentUserId = Guid.Parse(User.FindFirstValue(ClaimTypes.NameIdentifier));
    var ubiDaFare = Model.UbicazioniFiltrate.Where(u => !u.Completata).ToList();
    var ubiCompletate = Model.UbicazioniFiltrate.Where(u => u.Completata).ToList();
}

<div class="toast-container position-fixed end-0 p-3" style="z-index: 1050; top: 70px;">
    @if (TempData["ErrorMessage"] != null)
    {
        <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive"
             aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body"><i class="fa-solid fa-circle-exclamation me-2"></i> @TempData["ErrorMessage"]
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                        aria-label="Close"></button>
            </div>
        </div>
    }
</div>

<div>
    @await Html.PartialAsync("~/Features/SearchCard/_SearchCard.cshtml", Model.SearchCard)
</div>

@if (!Model.Chiuso)
{
    <div class="d-md-none mt-2 p-2">
        <div class="d-flex justify-content-end">
            <button type="button"
                    class="btn btn-danger"
                    data-post-action="true"
                    data-url="@Url.Action("ChiudiSessione", "Dettaglio", new { area = "Inventari", id = Model.SessioneId })"
                    data-message="Vuoi davvero chiudere lâ€™inventario <b>@Model.NomeSessione</b>?">
                <i class="fa-solid fa-lock me-2"></i>
                Termina
            </button>
        </div>
    </div>
}

@* --- VERSIONE DESKTOP (TABLE) --- *@
<div class="card border-0 shadow-sm mt-3 d-none d-md-block">
    <div class="card-body p-3">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                <tr>
                    <th class="ps-4 text-start" style="width: 30%">Ubicazione</th>
                    <th class="text-center" style="width: 20%">Stato</th>
                    <th class="text-end pe-4" style="width: 50%">Dettagli Operatore</th>
                </tr>
                </thead>
                <tbody>
                @if (ubiDaFare.Any())
                {
                    <tr class="table-secondary">
                        <td colspan="3" class="ps-4 fw-bold bg-body-secondary text-muted small text-uppercase">Da Fare</td>
                    </tr>
                    @foreach (var ubi in ubiDaFare)
                    {
                        var isMyUbi = ubi.OperatoreCorrenteId == currentUserId;
                        var canEnter = !ubi.InLavorazione || isMyUbi;

                        <tr style="@(canEnter ? "cursor:pointer" : "")"
                            @if (canEnter)
                            {
                            <text>onclick="window.location.href='@Url.Action("Index", "RilevamentoUbicazione", new { sessioneId = Model.SessioneId, ubicazioneId = ubi.UbicazioneId })'"
                            </text>
                            }>
                            
                            <td class="ps-4 text-start fw-bold text-primary">@ubi.Posizione</td>
                            
                            <td class="text-center">
                                @if (ubi.InLavorazione)
                                {
                                    <span class="badge bg-warning text-dark">
                                        <i class="fa-solid fa-circle fa-fade me-1"></i>In Corso
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-light text-dark border">In attesa</span>
                                }
                            </td>
                            
                            <td class="text-end pe-4">
                                @if (ubi.InLavorazione)
                                {
                                    <small><i class="fa-solid fa-user-gear me-1"></i> In lavorazione da:
                                        <strong>@ubi.OperatoreCorrente</strong></small>
                                }
                            </td>
                        </tr>
                    }
                }
                @if (ubiCompletate.Any())
                {
                    <tr class="table-secondary">
                        <td colspan="3" class="ps-4 fw-bold bg-body-secondary text-muted small text-uppercase">Completati</td>
                    </tr>
                    @foreach (var ubi in ubiCompletate)
                    {
                        <tr class="bg-light" style="cursor:pointer"
                            onclick="window.location.href='@Url.Action("Index", "RilevamentoUbicazione", new { sessioneId = Model.SessioneId, ubicazioneId = ubi.UbicazioneId })'">
                            @* Allineamento SX *@
                            <td class="ps-4 text-start fw-bold text-muted">@ubi.Posizione</td>

                            @* Allineamento CENTRO *@
                            <td class="text-center"><span class="badge bg-success">Completato</span></td>

                            @* Allineamento DX *@
                            <td class="text-end pe-4">
                                <small class="text-muted"><i class="fa-solid fa-check-double me-1"></i> Chiuso da:
                                    <strong>@ubi.OperatoreCorrente</strong></small>
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>
    </div>
</div>

@* --- VERSIONE MOBILE (CARDS) --- *@

<div class="d-md-none">
    
    @if (ubiDaFare.Any())
    {
        <div class="text-muted small fw-bold text-uppercase ms-1">Da Fare:</div>
        foreach (var ubi in ubiDaFare)
        {
            var isMyUbi = ubi.OperatoreCorrenteId == currentUserId;
            var canEnter = !ubi.InLavorazione || isMyUbi;
            <div class="card shadow-sm border-0 border-start border-5 mt-2 @(ubi.InLavorazione ? "border-warning" : "border-bg-light")"
                 style="@(canEnter ? "cursor:pointer" : "")"
                 @if (canEnter)
                 {
                     <text>onclick="window.location.href='@Url.Action("Index", "RilevamentoUbicazione", new { sessioneId = Model.SessioneId, ubicazioneId = ubi.UbicazioneId })'"
                     </text>
                 }>
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="fw-bold">
                            <div class="text-primary mb-1">@ubi.Posizione</div>
                            <small class="text-muted">
                                <i class="fa-solid fa-user me-1"></i> @(ubi.InLavorazione ? ubi.OperatoreCorrente : "Nessun operatore")
                            </small>
                        </div>
                        <div>
                            @if (ubi.InLavorazione)
                            {
                                <span class="badge text-bg-warning"><i class="fa-solid fa-circle fa-fade me-1"></i>In Corso</span>
                            }
                            else
                            {
                                <span class="badge border text-secondary bg-light">In attesa</span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    }

    @if (ubiCompletate.Any())
    {
        <div class="text-muted small fw-bold text-uppercase mt-3 ms-1">Completati:</div>
        @foreach (var ubi in ubiCompletate)
        {
            <div class="card shadow-sm border-0 border-start border-5 mt-2 border-success"
                 style="cursor:pointer"
                 onclick="window.location.href='@Url.Action("Index", "RilevamentoUbicazione", new { sessioneId = Model.SessioneId, ubicazioneId = ubi.UbicazioneId })'">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="fw-bold">
                            @* Rimossa classe text-decoration-line-through *@
                            <div class="text-muted mb-1">@ubi.Posizione</div>
                            <small class="text-muted"><i class="fa-solid fa-check me-1"></i> Chiuso
                                da: @ubi.OperatoreCorrente</small>
                        </div>
                        <div>
                            <span class="badge bg-success">Completato</span>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@Html.AntiForgeryToken()

@await Html.PartialAsync("~/Features/Modals/_ConfirmModal.cshtml",
    new LogiHub.Web.Features.Modals.ConfirmModalViewModel
    {
        ModalId = "actionConfirmModal",
        Title = "Conferma",
        Message = "",
        ConfirmButtonText = "Conferma",
        ConfirmButtonClass = "btn-primary",
        IconClass = "fa-solid fa-triangle-exclamation"
    })

@section Scripts {
    <script src="~/js/Features/Modals/ConfirmModal.js"></script>
    
    <script>
        console.log("Dettaglio.cshtml scripts loaded");
        document.addEventListener('DOMContentLoaded', function () {
            const toastEl = document.getElementById('errorToast');
            if (toastEl) {
                const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
                toast.show();
            }
        });

        window.addEventListener('pageshow', function (event) {
            if (event.persisted) {
                window.location.reload();
            }
        });

        (function () {
            let pendingForm = null;

            document.addEventListener('click', function (e) {
                const btn = e.target.closest('[data-confirm-modal-trigger="true"]');
                if (!btn) return;

                if (btn.getAttribute('data-confirm-modal') !== 'true') return;
                if (!btn) return;

                e.preventDefault();

                pendingForm = btn.closest('form');
                if (!pendingForm) return;

                const modalEl = document.getElementById('actionConfirmModal');
                if (!modalEl) {
                    pendingForm.submit();
                    pendingForm = null;
                    return;
                }

                const title = btn.getAttribute('data-confirm-title');
                const message = btn.getAttribute('data-confirm-message');
                const label = btn.getAttribute('data-confirm-label');

                const titleEl = modalEl.querySelector('.modal-title');
                const msgEl = modalEl.querySelector('[data-confirm-message]');
                const labelEl = modalEl.querySelector('[data-dynamic-label]');

                if (title && titleEl) titleEl.textContent = title;

                if (msgEl && message) {
                    msgEl.childNodes[0].textContent = message + " ";
                }

                if (labelEl) labelEl.textContent = label ?? "";

                bootstrap.Modal.getOrCreateInstance(modalEl).show();
            });

            document.addEventListener('click', function (e) {
                const confirmBtn = e.target.closest('#actionConfirmModal [data-confirm-btn]');
                if (!confirmBtn) return;

                e.preventDefault();

                if (pendingForm) {
                    pendingForm.submit();
                    pendingForm = null;
                }
            });

            document.addEventListener('hidden.bs.modal', function (e) {
                if (e.target && e.target.id === 'actionConfirmModal') {
                    pendingForm = null;
                }
            });
        })();
    </script>
}