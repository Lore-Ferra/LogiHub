@using System.Linq
@using LogiHub.Models.Shared
@model LogiHub.Web.Areas.Inventari.Sessioni.RilevamentoUbicazioneViewModel

@section Styles {
    <link rel="stylesheet" href="~/css/fab-button.css"/>
}


@{
    ViewData["Title"] = "Rilevamento " + Model.NomeUbicazione;
}

@if (Model.IsSolaLettura)
{
    <div class="alert alert-warning opacity-100 border-0 shadow-sm mb-3 d-flex align-items-center">
        <i class="fa-solid fa-lock me-3 fa-lg"></i>
        <div>
            <strong>Ubicazione Completata.</strong> Modalità sola lettura attiva.
        </div>
    </div>
}

<div>
    @await Html.PartialAsync("~/Features/SearchCard/_SearchCard.cshtml", Model.SearchCard)
</div>

<div class="container-fluid px-0">

    @* --- VERSIONE DESKTOP (TABLE) --- *@
    <div class="card border-0  shadow-sm d-none d-md-block">
        <div class="card-body p-3">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                    <tr>
                        <th class="ps-4" style="width: 20%">Barcode</th>
                        <th style="width: 50%">Descrizione</th>
                        <th class="text-center" style="width: 10%">Stato</th>
                        <th class="text-end pe-4" style="width: 20%">Azioni</th>
                    </tr>
                    </thead>
                    <tbody>
                    @if (Model.Pezzi != null && Model.Pezzi.Any())
                    {
                        @foreach (var pezzo in Model.Pezzi)
                        {
                            <tr id="row-@pezzo.RigaId">
                                <td class="ps-4 fw-bold text-primary">@pezzo.Barcode</td>
                                <td class="text-muted">@pezzo.Descrizione</td>

                                <td class="text-center">
                                    <span id="badge-d-@pezzo.RigaId"
                                          class="badge @(pezzo.Stato == StatoRigaInventario.InAttesa ? "bg-secondary" : pezzo.Stato == StatoRigaInventario.Trovato ? "bg-success" : "bg-danger")">
                                        @(pezzo.Stato == StatoRigaInventario.InAttesa ? "In Attesa" : pezzo.Stato.ToString())
                                    </span>
                                </td>

                                <td class="text-end pe-4">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary"
                                                onclick="aggiornaStato(this, '@pezzo.RigaId', 'presente')"
                                                data-url="@Url.Action("SegnaPresente", "RilevamentoUbicazione", new { rigaId = pezzo.RigaId })"
                                                style="@(Model.IsSolaLettura ? "cursor: not-allowed; pointer-events: auto !important;" : "")"
                                                @(Model.IsSolaLettura ? "disabled" : "")>
                                            @if (Model.IsSolaLettura && pezzo.Stato == StatoRigaInventario.Trovato)
                                            {
                                                <i class="fa-solid fa-lock"></i>
                                            }
                                            else
                                            {
                                                <i class="fa-solid fa-check"></i>
                                            }
                                            <span class="ms-1">Presente</span>
                                        </button>

                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="aggiornaStato(this, '@pezzo.RigaId', 'mancante')"
                                                data-url="@Url.Action("SegnaMancante", "RilevamentoUbicazione", new { rigaId = pezzo.RigaId })"
                                                style="@(Model.IsSolaLettura ? "cursor: not-allowed; pointer-events: auto !important;" : "")"
                                                @(Model.IsSolaLettura ? "disabled" : "")>
                                            @if (Model.IsSolaLettura && pezzo.Stato == StatoRigaInventario.Mancante)
                                            {
                                                <i class="fa-solid fa-lock"></i>
                                            }
                                            else
                                            {
                                                <i class="fa-solid fa-xmark"></i>
                                            }
                                            <span class="ms-1">Mancante</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @* --- VERSIONE MOBILE (CARDS) --- *@
    <div class="d-md-none">
        @foreach (var pezzo in Model.Pezzi)
        {
            <div id="card-@pezzo.RigaId"
                 class="card shadow-sm border-0 border-start border-5 mb-2 @(pezzo.Stato == StatoRigaInventario.Trovato ? "border-success" : pezzo.Stato == StatoRigaInventario.Mancante ? "border-danger" : "")">
                <div class="card-body p-2">
                    
                    <div class="d-flex justify-content-between align-items-start">
                        <p class="fw-bold fs-5 m-0 text-primary">@pezzo.Barcode</p>
                        <span id="badge-m-@pezzo.RigaId"
                              class="badge @(pezzo.Stato == StatoRigaInventario.InAttesa ? "bg-secondary" : pezzo.Stato == StatoRigaInventario.Trovato ? "bg-success" : "bg-danger")">
                            @(pezzo.Stato == StatoRigaInventario.InAttesa ? "In Attesa" : pezzo.Stato.ToString())
                        </span>
                    </div>
                    <hr class="my-1">    
                    <p class="small text-muted mb-0">@pezzo.Descrizione</p>
                    <div class="row g-2 mt-1 px-4">
                        <div class="col-6">
                            <button class="btn btn-md btn-primary w-100"
                                    onclick="aggiornaStato(this, '@pezzo.RigaId', 'presente')"
                                    data-url="@Url.Action("SegnaPresente", "RilevamentoUbicazione", new { rigaId = pezzo.RigaId })"
                                    style="@(Model.IsSolaLettura ? "cursor: not-allowed; pointer-events: auto !important;" : "")"
                                    @(Model.IsSolaLettura ? "disabled" : "")>
                                <i class="fa-solid @(Model.IsSolaLettura && pezzo.Stato == StatoRigaInventario.Trovato ? "fa-lock" : "fa-check")"></i>
                                Presente
                            </button>
                        </div>

                        <div class="col-6 font-s">
                            <button class="btn btn-md btn-danger w-100"
                                    onclick="aggiornaStato(this, '@pezzo.RigaId', 'mancante')"
                                    data-url="@Url.Action("SegnaMancante", "RilevamentoUbicazione", new { rigaId = pezzo.RigaId })"
                                    style="@(Model.IsSolaLettura ? "cursor: not-allowed; pointer-events: auto !important;" : "")"
                                    @(Model.IsSolaLettura ? "disabled" : "")>
                                <i class="fa-solid @(Model.IsSolaLettura && pezzo.Stato == StatoRigaInventario.Mancante ? "fa-lock" : "fa-xmark")"></i>
                                Mancante
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (!Model.IsSolaLettura)
        {
            <button type="button"
                    class="fab d-md-none border-0"
                    data-bs-toggle="modal" 
                    data-bs-target="#modalAggiungiExtra"
                    style="width: auto; padding: 0 20px; border-radius: 30px;">
                <i class="fa-solid fa-plus me-1"></i> Extra
            </button>
        }
        else
        {
            <button class="fab d-md-none btn btn-primary disabled" title="Aggiunta bloccata"
                    style="cursor: not-allowed; pointer-events: auto !important; width: auto; padding: 0 20px; border-radius: 30px;">
                <i class="fa-solid fa-lock"></i> Extra
            </button>
        }
    </div>

</div>

@Html.AntiForgeryToken()

@await Html.PartialAsync(
    "~/Features/Modals/_ConfirmModal.cshtml",
    new LogiHub.Web.Features.Modals.ConfirmModalViewModel
    {
        ModalId = "actionConfirmModal",
        Title = "Conferma operazione",
        Message = "",
        ConfirmButtonText = "Conferma",
        ConfirmButtonClass = "btn-primary",
        IconClass = "fa-solid fa-triangle-exclamation text-warning"
    })

@* MODAL ERRORE EXTRA *@
<div class="modal fade" id="modalErroreExtra" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false" style="z-index: 1065;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg text-center p-4">

            <div class="mb-3">
                <div class="rounded-circle bg-danger bg-opacity-10 d-inline-flex align-items-center justify-content-center"
                     style="width:64px;height:64px;">
                    <i class="fa-solid fa-xmark text-danger fs-3"></i>
                </div>
            </div>

            <h4 class="fw-bold mb-2">Errore</h4>

            <p id="msgErroreExtraText" class="text-muted mb-4"></p>

            <button type="button"
                    class="btn btn-danger w-100 py-2"
                    data-bs-dismiss="modal">
                OK
            </button>

        </div>
    </div>
</div>

@* MODAL AGGIUNGI EXTRA *@
<div class="modal fade" id="modalAggiungiExtra" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="fa-solid fa-box-open me-2 text-primary"></i>Aggiungi Extra</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formAggiungiExtra" onsubmit="submitAggiungiExtra(event)">
                <div class="modal-body">
                    <input type="hidden" name="sessioneId" value="@Model.SessioneId" />
                    <input type="hidden" name="ubicazioneId" value="@Model.UbicazioneId" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">Barcode</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="barcode" id="inputBarcodeExtra" required placeholder="Scansiona o inserisci..." />
                            @* Bottone Scan QR *@
                            <button type="button" class="btn btn-outline-secondary" onclick="simulaScanQR()" title="Simula Scansione">
                                <i class="fa-solid fa-qrcode"></i>
                            </button>
                        </div>
                        <div class="form-text">Se il barcode esiste già, verrà segnato come spostamento.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Descrizione (Opzionale)</label>
                        <textarea class="form-control" name="descrizione" rows="2" placeholder="Inserisci descrizione..."></textarea>
                        <div class="form-text text-muted">
                            <i class="fa-solid fa-circle-info me-1"></i>
                            Se lasciata vuota, verrà mantenuta quella esistente (se presente). Se compilata, sovrascriverà quella vecchia alla risoluzione.
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-link text-muted text-decoration-none" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary px-4">Aggiungi</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/Features/Modals/ConfirmModal.js"></script>
    
    <script>        
        async function aggiornaStato(btn, rigaId, tipo) {
            if (btn.disabled) return;

            const originalText = btn.innerHTML;
            const url = btn.getAttribute('data-url');

            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            const formData = new FormData();
            if (tokenInput) formData.append('__RequestVerificationToken', tokenInput.value);

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    console.error("Errore server:", response.statusText);
                    alert("Impossibile aggiornare. Forse l'ubicazione è stata chiusa?");
                    return;
                }

                const data = await response.json();
                
                if (data.conflict) {
                    mostraModaleConflitto(rigaId, data.extraId);
                    return;
                }

                const card = document.getElementById('card-' + rigaId);
                if (card) {
                    card.classList.remove('border-success', 'border-danger');
                    card.classList.add(tipo === 'presente' ? 'border-success' : 'border-danger');
                }

                const badgeDesktop = document.getElementById('badge-d-' + rigaId);
                const badgeMobile = document.getElementById('badge-m-' + rigaId);

                [badgeDesktop, badgeMobile].forEach(badge => {
                    if (!badge) return;

                    badge.classList.remove('bg-secondary', 'bg-success', 'bg-danger');
                    if (tipo === 'presente') {
                        badge.classList.add('bg-success');
                        badge.textContent = 'Trovato';
                    } else {
                        badge.classList.add('bg-danger');
                        badge.textContent = 'Mancante';
                    }
                });
            } catch (error) {
                console.error('Errore:', error);
                alert("Errore di connessione.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function submitAggiungiExtra(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                const response = await fetch('@Url.Action("AggiungiPezzo", "RilevamentoUbicazione")', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    location.reload();
                } else {
                    document.getElementById('msgErroreExtraText').innerText = data.message;
                    new bootstrap.Modal(document.getElementById('modalErroreExtra')).show();
                }
            } catch (error) {
                console.error(error);
                alert("Errore di comunicazione con il server.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        function mostraModaleConflitto(rigaId, extraId) {
            const modalEl = document.getElementById('actionConfirmModal');
            const modal = new bootstrap.Modal(modalEl);
            
            modalEl.querySelector('.modal-title').innerHTML = '<i class="fa-solid fa-triangle-exclamation text-warning me-2"></i>Conflitto Rilevato';
            modalEl.querySelector('[data-confirm-message]').innerText = "Esiste già un pezzo EXTRA con questo barcode. Vuoi eliminarlo e segnare questo come presente?";
            
            const btn = modalEl.querySelector('[data-confirm-btn]');
            // Clona il bottone per rimuovere vecchi listener
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.onclick = async function() {
                newBtn.disabled = true;
                newBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                
                const formData = new FormData();
                const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                if (tokenInput) formData.append('__RequestVerificationToken', tokenInput.value);
                formData.append('rigaId', rigaId);
                formData.append('extraId', extraId);
                
                await fetch('@Url.Action("RisolviConflittoPresente", "RilevamentoUbicazione")', {
                    method: 'POST',
                    body: formData
                });
                
                location.reload();
            };
            
            modal.show();
        }
        
        function simulaScanQR() {
            // Genera un numero casuale a 4 cifre e aggiunge #
            const randomCode = "#" + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            document.getElementById('inputBarcodeExtra').value = randomCode;
        }
    </script>
}
